<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khảo Sát Lịch Giảng Dạy</title>
    
    <!-- Tailwind CSS (Cần mạng internet để tải giao diện đẹp) -->
    <script src="https://cdn.tailwindcss.com" onerror="alert('Lỗi: Không thể tải thư viện giao diện (Tailwind). Vui lòng kiểm tra kết nối Internet!')"></script>
    
    <!-- Lucide Icons (Cần mạng internet) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- Font Noto Sans Vietnamese -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .fade-in-up { animation: fadeInUp 0.5s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Style cho nút chọn ngày */
        .day-btn.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .day-btn:not(.selected):hover {
            background-color: #eef2ff;
            border-color: #a5b4fc;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-50 py-8 px-4 sm:px-6">

    <div class="max-w-3xl mx-auto" id="main-container">
        
        <!-- Header -->
        <div class="text-center mb-10 fade-in-up">
            <h1 class="text-3xl font-extrabold text-indigo-900 flex items-center justify-center gap-3">
                <i data-lucide="book-open" class="w-8 h-8 text-indigo-600"></i>
                Khảo Sát Lịch Giảng Dạy
            </h1>
            <p class="mt-2 text-slate-600">
                Mời thầy/cô điền thông tin các ca dạy trong tuần để trung tâm sắp xếp.
            </p>
        </div>

        <form id="surveyForm" class="space-y-6 fade-in-up" onsubmit="handleSubmit(event)">
            
            <!-- Thông tin chung -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">
                    Họ và tên Giáo viên
                </label>
                <input
                    required
                    type="text"
                    id="teacherName"
                    placeholder="Ví dụ: Nguyễn Văn A"
                    class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                />
            </div>

            <!-- Danh sách các lịch dạy (Container chứa các thẻ) -->
            <div id="schedules-container" class="space-y-4">
                <!-- Các thẻ lịch sẽ được JS thêm vào đây -->
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button
                    type="button"
                    onclick="addSchedule()"
                    class="flex-1 py-3 px-4 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl font-semibold hover:bg-indigo-50 hover:border-indigo-400 transition-all flex items-center justify-center gap-2"
                >
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Thêm Lịch Dạy Khác
                </button>
                
                <button
                    type="submit"
                    id="submitBtn"
                    class="flex-1 py-3 px-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="btnText" class="flex items-center gap-2">
                        <i data-lucide="send" class="w-5 h-5"></i>
                        Gửi Khảo Sát
                    </span>
                    <div id="btnSpinner" class="spinner hidden"></div>
                </button>
            </div>
        </form>
        
        <p class="text-center text-slate-400 text-sm mt-8">
            Hệ thống khảo sát nội bộ - 2024
        </p>
    </div>

    <!-- Màn hình thành công (Ẩn mặc định) -->
    <div id="success-screen" class="hidden min-h-screen fixed inset-0 bg-slate-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center fade-in-up">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="check-circle" class="w-10 h-10 text-green-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Đã gửi thành công!</h2>
            <p class="text-slate-600" id="success-message">Cảm ơn thầy/cô đã cập nhật lịch giảng dạy.</p>
            <button 
                onclick="resetForm()"
                class="mt-6 px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors"
            >
                Gửi biểu mẫu khác
            </button>
        </div>
    </div>

    <!-- Template cho một thẻ lịch (Ẩn, dùng để clone ra nhiều thẻ) -->
    <template id="schedule-template">
        <div class="schedule-card bg-white rounded-xl shadow-md border-l-4 border-indigo-500 p-6 relative fade-in">
            <!-- Header của thẻ -->
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                <h3 class="font-bold text-indigo-900 schedule-title">Lịch dạy #1</h3>
                <button
                    type="button"
                    class="btn-remove text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-colors hidden"
                    title="Xóa lịch này"
                >
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tên Ca -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1">
                        <i data-lucide="book-open" class="w-4 h-4 text-slate-400"></i> Tên Ca / Lớp
                    </label>
                    <input
                        required
                        type="text"
                        name="shiftName"
                        placeholder="VD: Ca 246 5h30, Ca T7 CN..."
                        class="w-full px-3 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none"
                    />
                </div>

                <!-- Số HS theo Trường -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1">
                        <i data-lucide="map-pin" class="w-4 h-4 text-slate-400"></i> Số HS theo Trường
                    </label>
                    <input
                        required
                        type="text"
                        name="schoolName"
                        placeholder="VD: 6 NAN, 3 NTMK..."
                        class="w-full px-3 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none"
                    />
                </div>

                <!-- Số lượng học viên -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1">
                        <i data-lucide="users" class="w-4 h-4 text-slate-400"></i> Số lượng học viên
                    </label>
                    <input
                        required
                        type="number"
                        min="1"
                        name="studentCount"
                        placeholder="VD: 15"
                        class="w-full px-3 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none"
                    />
                </div>

                <!-- Giờ bắt đầu -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1">
                        <i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> Giờ bắt đầu
                    </label>
                    <input
                        required
                        type="time"
                        name="startTime"
                        class="w-full px-3 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none"
                    />
                </div>

                <!-- Chọn ngày -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-1">
                        <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i> Ngày dạy trong tuần (Chọn nhiều)
                    </label>
                    <div class="days-container flex flex-wrap gap-2">
                        <!-- JS sẽ điền các ngày vào đây -->
                    </div>
                    <p class="error-msg text-xs text-amber-500 mt-1 italic hidden">* Vui lòng chọn ít nhất 1 ngày</p>
                    <input type="hidden" name="selectedDays" value=""> 
                </div>
            </div>
        </div>
    </template>

    <script>
        // ==========================================
        // CẤU HÌNH KẾT NỐI GOOGLE SHEETS
        // Bước 1: Copy link "Web App URL" từ Google Apps Script
        // Bước 2: Dán vào giữa 2 dấu nháy đơn bên dưới
        const GOOGLE_SCRIPT_URL = ''; 
        // Ví dụ: const GOOGLE_SCRIPT_URL = 'https://script.google.com/.../exec';
        // ==========================================

        const DAYS = [
            { key: 'T2', label: 'Thứ 2' },
            { key: 'T3', label: 'Thứ 3' },
            { key: 'T4', label: 'Thứ 4' },
            { key: 'T5', label: 'Thứ 5' },
            { key: 'T6', label: 'Thứ 6' },
            { key: 'T7', label: 'Thứ 7' },
            { key: 'CN', label: 'C.Nhật' },
        ];

        let scheduleCount = 0;

        // Khởi chạy khi trang load xong
        document.addEventListener('DOMContentLoaded', () => {
            // Kiểm tra và khởi tạo icon an toàn
            try {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                } else {
                    console.warn("Thư viện Lucide chưa tải xong. Icon có thể không hiện.");
                }
            } catch (e) { console.error(e); }

            addSchedule(); // Thêm 1 thẻ mặc định đầu tiên
        });

        // Hàm thêm lịch mới
        function addSchedule() {
            scheduleCount++;
            const container = document.getElementById('schedules-container');
            const template = document.getElementById('schedule-template');
            const clone = template.content.cloneNode(true);

            const card = clone.querySelector('.schedule-card');
            card.id = `schedule-${scheduleCount}`;
            card.querySelector('.schedule-title').textContent = `Lịch dạy #${scheduleCount}`;

            // Nút xóa
            const btnRemove = card.querySelector('.btn-remove');
            btnRemove.onclick = () => removeSchedule(card.id);

            // Tạo các nút chọn ngày
            const daysContainer = card.querySelector('.days-container');
            const hiddenInput = card.querySelector('input[name="selectedDays"]');
            
            DAYS.forEach(day => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'day-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border bg-white text-slate-600 border-slate-200';
                btn.textContent = day.label;
                btn.dataset.key = day.key;
                
                btn.onclick = () => {
                    btn.classList.toggle('selected');
                    updateSelectedDays(card, hiddenInput);
                };
                daysContainer.appendChild(btn);
            });

            container.appendChild(clone);
            updateRemoveButtons();
            
            // Render lại icon cho phần tử mới
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Cuộn xuống thẻ mới tạo
            if (scheduleCount > 1) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Hàm xóa lịch
        function removeSchedule(id) {
            const card = document.getElementById(id);
            if (card) {
                card.remove();
                updateScheduleNumbers();
                updateRemoveButtons();
            }
        }

        // Cập nhật lại số thứ tự (Lịch #1, Lịch #2...)
        function updateScheduleNumbers() {
            const cards = document.querySelectorAll('.schedule-card');
            scheduleCount = cards.length;
            cards.forEach((card, index) => {
                card.querySelector('.schedule-title').textContent = `Lịch dạy #${index + 1}`;
            });
        }

        // Ẩn nút xóa nếu chỉ còn 1 thẻ
        function updateRemoveButtons() {
            const cards = document.querySelectorAll('.schedule-card');
            const buttons = document.querySelectorAll('.btn-remove');
            
            if (cards.length === 1) {
                buttons.forEach(btn => btn.classList.add('hidden'));
            } else {
                buttons.forEach(btn => btn.classList.remove('hidden'));
            }
        }

        // Cập nhật giá trị ngày vào ô ẩn (Hidden Input)
        function updateSelectedDays(card, hiddenInput) {
            const selectedBtns = card.querySelectorAll('.day-btn.selected');
            const keys = Array.from(selectedBtns).map(btn => btn.dataset.key);
            
            // Sắp xếp ngày theo thứ tự T2 -> CN
            keys.sort((a, b) => DAYS.findIndex(d => d.key === a) - DAYS.findIndex(d => d.key === b));

            hiddenInput.value = keys.join(',');
            
            // Hiện/Ẩn thông báo lỗi
            const errorMsg = card.querySelector('.error-msg');
            if (keys.length === 0) errorMsg.classList.remove('hidden');
            else errorMsg.classList.add('hidden');
        }

        // Xử lý khi bấm nút Gửi
        function handleSubmit(e) {
            e.preventDefault();
            
            const scheduleCards = document.querySelectorAll('.schedule-card');
            let isValid = true;
            let firstInvalidCard = null;

            // Kiểm tra xem đã chọn ngày chưa
            scheduleCards.forEach(card => {
                const hiddenInput = card.querySelector('input[name="selectedDays"]');
                const errorMsg = card.querySelector('.error-msg');
                
                if (!hiddenInput.value) {
                    isValid = false;
                    errorMsg.classList.remove('hidden');
                    if (!firstInvalidCard) firstInvalidCard = card;
                } else {
                    errorMsg.classList.add('hidden');
                }
            });

            if (!isValid) {
                if (firstInvalidCard) firstInvalidCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Hiển thị trạng thái Loading
            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            btn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            // Thu thập dữ liệu
            const teacherName = document.getElementById('teacherName').value;
            const schedules = [];

            scheduleCards.forEach((card, index) => {
                schedules.push({
                    id: index + 1,
                    shiftName: card.querySelector('input[name="shiftName"]').value,
                    schoolName: card.querySelector('input[name="schoolName"]').value,
                    studentCount: card.querySelector('input[name="studentCount"]').value,
                    startTime: card.querySelector('input[name="startTime"]').value,
                    selectedDays: card.querySelector('input[name="selectedDays"]').value.split(',')
                });
            });

            const finalData = { teacherName, schedules };
            console.log("Dữ liệu gửi đi:", finalData);

            // Gửi dữ liệu (Nếu có link Script)
            if (GOOGLE_SCRIPT_URL) {
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Quan trọng
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalData)
                })
                .then(() => showSuccess(teacherName))
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi gửi dữ liệu. Vui lòng thử lại!');
                    stopLoading();
                });
            } else {
                // Chế độ demo (chưa có link script)
                console.warn("Chưa cấu hình GOOGLE_SCRIPT_URL. Dữ liệu chỉ hiện ở Console.");
                // Giả lập delay 1 giây rồi báo thành công
                setTimeout(() => {
                    showSuccess(teacherName);
                }, 1000);
            }
        }

        function stopLoading() {
            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            btn.disabled = false;
            btnText.classList.remove('hidden');
            btnSpinner.classList.add('hidden');
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }

        function showSuccess(name) {
            stopLoading();
            document.getElementById('success-message').textContent = `Cảm ơn thầy/cô ${name} đã cập nhật lịch giảng dạy.`;
            document.getElementById('success-screen').classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('success-screen').classList.add('hidden');
            document.getElementById('surveyForm').reset();
            const container = document.getElementById('schedules-container');
            container.innerHTML = '';
            scheduleCount = 0;
            addSchedule();
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
